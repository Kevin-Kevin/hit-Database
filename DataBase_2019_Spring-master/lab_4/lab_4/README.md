# Lab 4

## 文件说明
- `extmem.h, extmem.c`为实验所提供的库，版权为[邹兆年老师](http://homepage.hit.edu.cn/zou)所有。
- `test.c`为实验所提供的库文件使用参考。
- `random.h, random.c`为随机生成实验数据，其中R关系112条元组，S关系224条元组。
- `lab4.c`为此次实验的主要文件。

## 关于ExtMem库的一些注意事项
1. `numFreeBlk` 可能比 `numAllBlk`还大，所以`numFreeBlk`没有参考价值，其更新过于混乱。
2. 在使用`writeBlockToDisk`函数后无需手动释放输出缓存，已经在函数内部Free过了。

## 使用ExtMem库的我所遵守的一些原则
1. 在使用后将函数内局部使用的Buffer Block释放，保持调用函数前后缓存中的block数目不变。
2. 使用的所有函数都遵循`test.c`中给出的原则。

## 存储元组的方式
**以下表示均为示意性的，真实的表示中仅有括号内的整数且按照2进制存储。**
1. 对于普通的关系（有2个integer类型的属性）存储格式为
```
40000 (20, 916, 20, 787, 21, 926, 21, 556, 21, 726, 22, 903, 22, 423, 40064, 0)
```
其中第一个整数为块地址，括号内的两个为一组，如`20, 916`表示一个元组，每一个块内保存7个元组；对于最后8个字节，前4个字节保存下一个块的地址（如果为0表示没有下一块），最后4个字节为0。

2. 对于投影后的关系（有1个integer类型的属性）存储格式为
```
60000 (2, 2, 2, 3, 3, 3, 4, 6, 7, 7, 8, 9, 9, 9, 9, 60064)
```
其中第一个仍然为块地址，括号内每一个整数为投影后的一个元组，每一个块内可以保存15个元组；对于最后4个字节保存下一个块的地址（如果为0表示没有下一块）。

3. 对于连接后的关系（有3个integer类型的属性）存储格式为
```
70000 (40, 790, 925, 40, 790, 572, 40, 790, 924, 40, 790, 14, 40, 790, 245, 70064)
```
其中第一个仍然是块地址，括号内每3个整数为连接后的一个元组（其中第1个整数为R.A和S.C，第2个整数为R.B，第3个整数为S.D）；最后4个字节表示下一个块的地址（如果为0则表示没有下一个块）。

4. 对于B+ Tree里面节点的存储，主要有两种分别是内节点的存储和叶子节点的存储，且使用的B+ Tree的度为6。

   1. 内节点的存储
   ```
   80000 (80064, 8, 80128, 16, 80192, 22, 80256, 29, 80320, 35, 80384, 0, 0, 0, 0, -1)
   ```
   其中最后4个字节为-1，表示这是一个内节点；由于度为6，所以在存储内节点的块的倒数5-12字节均为0；除此以外，从开始的偶数4字节处记录的是，有小于紧跟其后4字节记录的整数对应的索引属性并且大于等于其左侧4字节记录整数对应的索引属性的元组。

   2. 叶节点的存储
   ```
   80064 (1, 50000, 2, 50000, 3, 50000, 4, 50064, 6, 50064, 7, 50064, 0, 0, 0, 0)
   ```
   由于度为6，所以每一个叶子块的最后16字节为0；从开始的偶数4字节为索引属性的值，紧跟其后的奇数4字节为对应包含该索引属性值的块地址。

5. 对于hash函数得到的桶，其存储格式为
```
1001344 (40, 924, 40, 14, 40, 245, 20, 90, 20, 176, 40, 700, 60, 81, 1002240, 7)
1002240 (40, 430, 40, 213, 60, 284, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3)
```
其中第一个整数表示该块的地址；最后8个字节，前4个字节表示如果该桶如果有下一个块存在，则为对应的块地址，如果没有下一个块存在则其为0，后4个字节表示该块内已经记录的元组个数，如对于第一条记录，其记录了7条元组。
